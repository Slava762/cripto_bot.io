<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Trading Chart</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #131722; color: white; }
        .chart-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
    </style>
</head>
<body>
    <div class="chart-container">
        <canvas id="tradingChart"></canvas>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); // Раскрываем приложение на весь экран

        const ctx = document.getElementById('tradingChart').getContext('2d');
        const chartData = {
            datasets: [{
                label: 'BTC/USD',
                data: [], // Начинаем с пустых данных
                borderColor: 'rgba(3, 194, 131, 1)',
                borderWidth: 2.5,
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(3, 194, 131, 0.1)',
                pointRadius: 0,
            }]
        };

        const chart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } }, ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                    y: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                },
                plugins: { legend: { display: false } },
                animation: { duration: 200 }
            }
        });

        let lastValue = 105800;
        let trend = 'random'; // Тренд по умолчанию

        // --- ЛОГИКА WEBSOCKET ---
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);

        ws.onopen = () => console.log("WebSocket connected!");
        ws.onmessage = (event) => {
            // Получаем новый тренд с сервера
            trend = event.data; 
            console.log("New trend received:", trend);
        };
        ws.onclose = () => console.log("WebSocket disconnected.");
        ws.onerror = (error) => console.error("WebSocket Error:", error);


        // --- ОБНОВЛЕНИЕ ГРАФИКА ---
        function addData() {
            const data = chart.data.datasets[0].data;
            const fluctuation = Math.random() * 25; // Амплитуда колебаний

            if (trend === 'up') {
                lastValue += fluctuation;
            } else if (trend === 'down') {
                lastValue -= fluctuation;
            } else { // random
                lastValue += (fluctuation - 12.5); // Случайное движение
            }

            // Не даем графику уйти слишком далеко
            if (lastValue < 10000) lastValue = 10000;

            const newDataPoint = { x: Date.now(), y: lastValue };
            data.push(newDataPoint);

            // Ограничиваем количество точек на графике
            if (data.length > 50) {
                data.shift();
            }

            chart.update();
        }

        // Запускаем обновление графика каждую секунду
        setInterval(addData, 1000);
    </script>
</body>
</html>
